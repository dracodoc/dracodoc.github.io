<!doctype html>
<html class="theme-next  theme-next-mist">
<head>
  

<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />








  <link rel="stylesheet" type="text/css" href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5"/>



  
    <link href='//fonts.googleapis.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext' rel='stylesheet' type='text/css'>
  


<link rel="stylesheet" type="text/css" href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" />

<link rel="stylesheet" type="text/css" href="/css/main.css?v=0.4.5.2"/>


    <meta name="description" content="Artificial learning and Evolution inspired by nature" />



  <meta name="keywords" content="Hexo,next" />





  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=0.4.5.2" />


<meta name="description" content="Artificial learning and Evolution inspired by nature">
<meta property="og:type" content="website">
<meta property="og:title" content="Artificial Learning and Evolution inspired by Nature">
<meta property="og:url" content="http://dracodoc.github.io/index.html">
<meta property="og:site_name" content="Artificial Learning and Evolution inspired by Nature">
<meta property="og:description" content="Artificial learning and Evolution inspired by nature">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Artificial Learning and Evolution inspired by Nature">
<meta name="twitter:description" content="Artificial learning and Evolution inspired by nature">


<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: 'Mist',
    sidebar: 'always'
  };
</script>



  <title> Artificial Learning and Evolution inspired by Nature </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->
  






  <div class="container one-column 
   page-home 
">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Artificial Learning and Evolution inspired by Nature</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu ">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
            Home
          </a>
        </li>
      

      
      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content"> 
  <section id="posts" class="posts-expand">
    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2015/10/20/simple-python-performance-timing-by-checkpoints/" itemprop="url">
                  Simple Python performance timing by checkpoints
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            Posted on
            <time itemprop="dateCreated" datetime="2015-10-20T20:16:43-04:00" content="2015-10-20">
              2015-10-20
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; In
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Programming/" itemprop="url" rel="index">
                    <span itemprop="name">Programming</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/2015/10/20/simple-python-performance-timing-by-checkpoints/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/10/20/simple-python-performance-timing-by-checkpoints/" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p><em><a href="https://dracodoc.wordpress.com/2015/01/15/a-python-script-inline-timer/" target="_blank" rel="external">The first version of this article</a> was written on 2015-01-15. It was updated when I moved my blog to github pages.</em></p>
<h2 id="The_Problem_and_the_first_solution">The Problem and the first solution</h2><p>I have been revisiting Python recently and walked through <a href="https://developers.google.com/edu/python/" target="_blank" rel="external">Google’s tutorial</a>. Interestingly my first solution to one of the exercise <strong><em>word count</em></strong> took a lot of time to analysis a 600K text.</p>
<p>I wanted some profile tool to locate the bottle neck. There are lots of profiler tools but they seemed to be too “heavy weighted” for my simple purpose. <a href="http://www.huyng.com/posts/python-performance-analysis/" target="_blank" rel="external">This great Python profiler guide</a> introduced a simple <em>timing context manager</em> script to measure script execution. You will need to</p>
<blockquote>
<p>wrap blocks of code that you want to time with Python’s <em>with</em> keyword and this <em>Timer</em> context manager. It will take care of starting the timer when your code block begins execution and stopping the timer when your code block ends.</p>
</blockquote>
<p>Like this</p>
<pre><code><span class="keyword">from</span> timer <span class="keyword">import</span> Timer
<span class="keyword">from</span> redis <span class="keyword">import</span> Redis
rdb = Redis()

<span class="keyword">with</span> Timer() <span class="keyword">as</span> t:
    rdb.lpush(<span class="string">"foo"</span>, <span class="string">"bar"</span>)
<span class="keyword">print</span> <span class="string">"=&gt; elasped lpush: %s s"</span> % t.secs

<span class="keyword">with</span> Timer() <span class="keyword">as</span> t:
    rdb.lpop(<span class="string">"foo"</span>)
<span class="keyword">print</span> <span class="string">"=&gt; elasped lpop: %s s"</span> % t.secs
</code></pre><p>I used this method and found out the problem in my script is that I used</p>
<pre><code><span class="keyword">if</span> key <span class="keyword">in</span> dict.<span class="function"><span class="title">keys</span><span class="params">()</span></span> 
</code></pre><p>which seems natural since I saw this before:</p>
<pre><code><span class="keyword">for</span> key <span class="keyword">in</span> <span class="function"><span class="title">sorted</span><span class="params">(dict.keys()</span></span>):
</code></pre><p>However, this is a linear look up in a list which didn’t utilize the constant time access of HashMap. The right way is to use dict directly without keys().</p>
<pre><code><span class="keyword">if</span> <span class="keyword">key</span> <span class="keyword">in</span> dict
</code></pre><p>So the problem was solved but I still found the timing context manager not simple and intuitive enough. Adding timer means lots of edits and indents of original code, and moving checkpoints involves more editing and indenting.</p>
<h2 id="My_simple_script_that_timing_code_by_checkpoints">My simple script that timing code by checkpoints</h2><p>I wrote a simple script that have similar function of timing code blocks by checkpoints, tried to keep the effort of using it minimal. Just first import the module, then place some checkpoints in the location you want.</p>
<ul>
<li>Place <code>times.start(digit)</code> in the place that you want the timer start. <code>digit</code> control the digits after the decimal point, default at 7.</li>
<li>Use <code>times.seg_start(&quot;msg&quot;)</code> and <code>times.seg_stop(&quot;msg&quot;)</code> enclose a code block and print the time of start and stop. <code>msg</code> can be used to identify the code block in the output. </li>
<li>You can also add single checkpoint <code>times.last_seg</code> anywhere, it will print the time elapsed since last checkpoint which could be of any type.</li>
</ul>
<p>Here is an example of using timing script in <strong><em>Wordcount</em></strong>. You can search and highlight <code>times</code> to see all the edits needed in script.</p>
<figure class="highlight py"><figcaption><span>wordcount.py</span><a href="/downloads/code/wordcount.py">view raw</a></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python -tt</span></span><br><span class="line"><span class="comment"># Copyright 2010 Google Inc.</span></span><br><span class="line"><span class="comment"># Licensed under the Apache License, Version 2.0</span></span><br><span class="line"><span class="comment"># http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Google's Python Class</span></span><br><span class="line"><span class="comment"># http://code.google.com/edu/languages/google-python-class/</span></span><br><span class="line"></span><br><span class="line"><span class="string">"""Wordcount exercise</span><br><span class="line">Google's Python class</span><br><span class="line">"""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> basic.util <span class="keyword">import</span> times</span><br><span class="line"></span><br><span class="line"><span class="comment">###</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># This basic command line argument parsing code is provided and</span></span><br><span class="line"><span class="comment"># calls the print_words() and print_top() functions which you must define.</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">count_words</span><span class="params">(filename)</span>:</span></span><br><span class="line">    <span class="string">"""helper method for the other 2, return dict"""</span></span><br><span class="line">    <span class="comment"># read file into words</span></span><br><span class="line">    times.seg_start(<span class="string">'count words start'</span>)</span><br><span class="line">    f = open(filename, <span class="string">'rU'</span>)</span><br><span class="line">    word_count = {}</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">        words = line.split()</span><br><span class="line">        <span class="keyword">for</span> word <span class="keyword">in</span> words:</span><br><span class="line">            word = word.lower()</span><br><span class="line">            <span class="keyword">if</span> word <span class="keyword">in</span> word_count:    <span class="comment"># 0.069 for 640k</span></span><br><span class="line">            <span class="comment">#if word_count.get(word): # 0.03s for 250k text, 0.084 for 640k</span></span><br><span class="line">                word_count[word] += <span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                word_count[word] = <span class="number">1</span></span><br><span class="line">    times.seg_stop(<span class="string">'count words stop'</span>)</span><br><span class="line">    <span class="keyword">return</span> word_count</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">print_words</span><span class="params">(filename)</span>:</span></span><br><span class="line">    <span class="string">"count words"</span></span><br><span class="line">    <span class="comment">#sort dict and print</span></span><br><span class="line">    word_count = count_words(filename)</span><br><span class="line">    <span class="keyword">for</span> word <span class="keyword">in</span> sorted(word_count.keys()):</span><br><span class="line">        <span class="keyword">print</span> word, word_count[word]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">print_top</span><span class="params">(filename)</span>:</span></span><br><span class="line">    word_count = count_words(filename)</span><br><span class="line">    word_count_pairs = word_count.items()</span><br><span class="line">    times.seg_start(<span class="string">'sorting start'</span>)</span><br><span class="line">    word_count_pairs = sorted(word_count_pairs, key = <span class="keyword">lambda</span> pair: pair[-<span class="number">1</span>], reverse=<span class="keyword">True</span>)</span><br><span class="line">    times.seg_stop(<span class="string">'sorting stop'</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>):</span><br><span class="line">        <span class="keyword">print</span> word_count_pairs[i][<span class="number">0</span>], word_count_pairs[i][<span class="number">1</span>]</span><br><span class="line">    times.last_seg()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">  <span class="keyword">if</span> len(sys.argv) != <span class="number">3</span>:</span><br><span class="line">    <span class="keyword">print</span> <span class="string">'usage: ./wordcount.py {--count | --topcount} file'</span></span><br><span class="line">    sys.exit(<span class="number">1</span>)</span><br><span class="line">  times.start(<span class="number">5</span>)</span><br><span class="line">  option = sys.argv[<span class="number">1</span>]</span><br><span class="line">  filename = sys.argv[<span class="number">2</span>]</span><br><span class="line">  <span class="keyword">if</span> option == <span class="string">'--count'</span>:</span><br><span class="line">    print_words(filename)</span><br><span class="line">  <span class="keyword">elif</span> option == <span class="string">'--topcount'</span>:</span><br><span class="line">    print_top(filename)</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">print</span> <span class="string">'unknown option: '</span> + option</span><br><span class="line">    sys.exit(<span class="number">1</span>)</span><br><span class="line">  times.end()</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">  main()</span><br></pre></td></tr></table></figure>
<p>I put some efforts in the print indenting to make the output aligned:</p>
<figure class="highlight plain"><figcaption><span>output</span></figcaption><table><tr><td class="code"><pre><span class="line">==&#62;| Timer start | set to 5 digits after decimal point&#10;=&#62; &#60;&#60; | 0          count words start&#10;      | 0.06900 s  count words stop  &#62;&#62;&#10;=&#62; &#60;&#60; | 0          sorting start&#10;      | 0.00800 s  sorting stop  &#62;&#62;&#10;the 5027&#10;to 3353&#10;and 2831&#10;=&#62; | 0.00100 s since last point&#10;=&#62; | 0.00300 s since last point. Timer end.&#10;| 0.08600 s Total time elapsed |</span><br></pre></td></tr></table></figure>
<p>Here is the script. You can also download it from the link in right top corner of code block.</p>
<figure class="highlight python"><figcaption><span>times.py</span><a href="https://github.com/dracodoc/misc_utils/blob/master/times.py" target="_blank" rel="external">Open in Github</a></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">__author__ = <span class="string">'dracodoc'</span></span><br><span class="line"><span class="comment"># measure script time duration in segments. http://dracodoc.github.io/</span></span><br><span class="line"><span class="comment"># the clock value list: start, segments, end</span></span><br><span class="line"><span class="comment"># usage: import times, put times.start, seg_start, end etc in line.</span></span><br><span class="line">T = []</span><br><span class="line">Digit = [<span class="number">7</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">start</span><span class="params">(digit=<span class="number">7</span>)</span>:</span></span><br><span class="line">    <span class="string">"""Timer start. digit control the number width to align"""</span></span><br><span class="line">    <span class="keyword">del</span> T[:]  <span class="comment"># clean up first</span></span><br><span class="line">    Digit[<span class="number">0</span>] = digit</span><br><span class="line">    T.append(time.time())</span><br><span class="line">    <span class="keyword">print</span> <span class="string">'==&gt;| Timer start | set to'</span>, Digit[<span class="number">0</span>], <span class="string">'digits after decimal point'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">last_seg</span><span class="params">(s=<span class="string">'since last point'</span>)</span>:</span></span><br><span class="line">    <span class="string">"""calculate the duration between last point till this one"""</span></span><br><span class="line">    T.append(time.time())</span><br><span class="line">    duration = T[-<span class="number">1</span>] - T[-<span class="number">2</span>]</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"=&gt; | %.*f s"</span> % (Digit[<span class="number">0</span>], duration), s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">seg_start</span><span class="params">(s=<span class="string">'start...'</span>)</span>:</span></span><br><span class="line">    <span class="string">"""set a segment start, always used with seg_stop in pairs"""</span></span><br><span class="line">    T.append(time.time())</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"=&gt; &lt;&lt; | 0"</span>, <span class="string">' '</span> * (Digit[<span class="number">0</span>] + <span class="number">3</span>), s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">seg_stop</span><span class="params">(s=<span class="string">'...stop'</span>)</span>:</span></span><br><span class="line">    <span class="string">"""set a segment end, always used with seg_start in pairs"""</span></span><br><span class="line">    T.append(time.time())</span><br><span class="line">    duration = T[-<span class="number">1</span>] - T[-<span class="number">2</span>]</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"      | %.*f s "</span> % (Digit[<span class="number">0</span>], duration), s, <span class="string">' &gt;&gt;'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">end</span><span class="params">(s=<span class="string">'since last point. Timer end.'</span>)</span>:</span></span><br><span class="line">    T.append(time.time())</span><br><span class="line">    duration = T[-<span class="number">1</span>] - T[-<span class="number">2</span>]</span><br><span class="line">    total = T[-<span class="number">1</span>] - T[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"=&gt; | %.*f s"</span> % (Digit[<span class="number">0</span>], duration), s</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"==&gt;| %.*f s"</span> % (Digit[<span class="number">0</span>], total), <span class="string">'Total time elapsed'</span></span><br></pre></td></tr></table></figure>
<p>Of course sometimes you want more features like execution frequency and memory analysis, then you can always use more powerful profiler like <a href="https://github.com/rkern/line_profiler" target="_blank" rel="external">line_profiler</a> and <a href="https://github.com/fabianp/memory_profiler" target="_blank" rel="external">memory profiler</a>. The profiler guide I mentioned earlier have detailed introductions on them. </p>
<p>That being said, I still found my simple timing script is often useful enough and easy to use with minimal overhead.</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  

 </div>

        

        
      </div>

      
        
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" src="/images/default_avatar.jpg" alt="dracodoc" itemprop="image"/>
          <p class="site-author-name" itemprop="name">dracodoc</p>
        </div>
        <p class="site-description motion-element" itemprop="description">Artificial learning and Evolution inspired by nature</p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/">
              <span class="site-state-item-count">1</span>
              <span class="site-state-item-name">posts</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            
              <span class="site-state-item-count">1</span>
              <span class="site-state-item-name">categories</span>
              
          </div>

          <div class="site-state-item site-state-tags">
            
              <span class="site-state-item-count">1</span>
              <span class="site-state-item-name">tags</span>
              
          </div>

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      

    </div>
  </aside>


      
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner"> <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2015</span>
  <span class="with-love">
    <i class="icon-next-heart fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">dracodoc</span>
</div>

<div class="powered-by">
  Powered by <a class="theme-link" href="http://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


 </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  
  
    
    

  

    <script type="text/javascript">
      var disqus_shortname = 'dracodocgithub';
      var disqus_identifier = 'index.html';
      var disqus_title = '';
      var disqus_url = '';

      function run_disqus_script(disqus_script){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');
      
    </script>
  


  
  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.5.2"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.5.2"></script>
  

  <script type="text/javascript" src="/js/motion_fallback.js?v=0.4.5.2" id="motion.fallback"></script>




  <script type="text/javascript" src="/js/nav-toggle.js?v=0.4.5.2"></script>
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  

  <script type="text/javascript">
    $(document).ready(function () {
      if (CONFIG.sidebar === 'always') {
        displaySidebar();
      }
      if (isMobile()) {
        FastClick.attach(document.body);
      }

      motionIntegrator.bootstrap();
    });
  </script>

  
  

  
  

  
  <script type="text/javascript" src="/js/lazyload.js"></script>
  <script type="text/javascript">
    $(function () {
      $("#posts").find('img').lazyload({
        placeholder: "/images/loading.gif",
        effect: "fadeIn"
      });
    });
  </script>
</body>
</html>
