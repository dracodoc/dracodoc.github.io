<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Simple Python performance timing by checkpoints | Artificial Learning and Evolution inspired by Nature</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="The first version of this article was written on 2015-01-15. It was updated when I moved my blog to github pages.
The CauseI have been revisiting Python recently and walked through Google’s tutorial.">
<meta property="og:type" content="article">
<meta property="og:title" content="Simple Python performance timing by checkpoints">
<meta property="og:url" content="http://dracodoc.github.io/2015/10/20/simple-python-performance-timing-by-checkpoints/index.html">
<meta property="og:site_name" content="Artificial Learning and Evolution inspired by Nature">
<meta property="og:description" content="The first version of this article was written on 2015-01-15. It was updated when I moved my blog to github pages.
The CauseI have been revisiting Python recently and walked through Google’s tutorial.">
<meta property="og:updated_time" content="2015-10-21T14:12:11.024Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Simple Python performance timing by checkpoints">
<meta name="twitter:description" content="The first version of this article was written on 2015-01-15. It was updated when I moved my blog to github pages.
The CauseI have been revisiting Python recently and walked through Google’s tutorial.">
  
    <link rel="alternative" href="/atom.xml" title="Artificial Learning and Evolution inspired by Nature" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  

</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Artificial Learning and Evolution inspired by Nature</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://dracodoc.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-simple-python-performance-timing-by-checkpoints" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/10/20/simple-python-performance-timing-by-checkpoints/" class="article-date">
  <time datetime="2015-10-21T00:16:43.000Z" itemprop="datePublished">2015-10-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Simple Python performance timing by checkpoints
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><em><a href="https://dracodoc.wordpress.com/2015/01/15/a-python-script-inline-timer/" target="_blank" rel="external">The first version of this article</a> was written on 2015-01-15. It was updated when I moved my blog to github pages.</em></p>
<h3 id="The_Cause">The Cause</h3><p>I have been revisiting Python recently and walked through <a href="https://developers.google.com/edu/python/" target="_blank" rel="external">Google’s tutorial</a>. Interestingly my first solution to one of the exercise <strong><em>word count</em></strong> took a lot of time to analysis a 600K text.</p>
<p>I wanted some profile tool to locate the bottle neck. There are lots of profiler tools but they seemed to be too “heavy weighted” for my simple purpose. <a href="http://www.huyng.com/posts/python-performance-analysis/" target="_blank" rel="external">This great Python profiler guide</a> introduced a simple <em>timing context manager</em> script to measure script execution. You will need to</p>
<blockquote>
<p>wrap blocks of code that you want to time with Python’s <em>with</em> keyword and this <em>Timer</em> context manager. It will take care of starting the timer when your code block begins execution and stopping the timer when your code block ends.</p>
</blockquote>
<p>Like this</p>
<pre><code><span class="keyword">from</span> timer <span class="keyword">import</span> Timer
<span class="keyword">from</span> redis <span class="keyword">import</span> Redis
rdb = Redis()

<span class="keyword">with</span> Timer() <span class="keyword">as</span> t:
    rdb.lpush(<span class="string">"foo"</span>, <span class="string">"bar"</span>)
<span class="keyword">print</span> <span class="string">"=&gt; elasped lpush: %s s"</span> % t.secs

<span class="keyword">with</span> Timer() <span class="keyword">as</span> t:
    rdb.lpop(<span class="string">"foo"</span>)
<span class="keyword">print</span> <span class="string">"=&gt; elasped lpop: %s s"</span> % t.secs
</code></pre><p>I used this method and found out the problem in my script is that I used</p>
<pre><code><span class="keyword">if</span> key <span class="keyword">in</span> dict.<span class="function"><span class="title">keys</span><span class="params">()</span></span> 
</code></pre><p>which seems natural since I saw this before:</p>
<pre><code><span class="keyword">for</span> key <span class="keyword">in</span> <span class="function"><span class="title">sorted</span><span class="params">(dict.keys()</span></span>):
</code></pre><p>However, this is a linear look up in a list which didn’t utilize the constant time access of HashMap. The right way is to use dict directly without keys().</p>
<pre><code><span class="keyword">if</span> <span class="keyword">key</span> <span class="keyword">in</span> dict
</code></pre><p>So the problem was solved but I still found the timing context manager not simple and intuitive enough. Adding timer means lots of edits and indents of original code, and moving checkpoints involves more editing and indenting.</p>
<h3 id="My_simple_script_that_timing_code_by_checkpoints">My simple script that timing code by checkpoints</h3><p>I wrote a simple script that have similar function of timing code blocks by checkpoints, tried to keep the effort of using it minimal. Just first import the module, then place some checkpoints in the location you want.</p>
<ul>
<li>Place <code>times.start(digit)</code> in the place that you want the timer start. <code>digit</code> control the digits after the decimal point, default at 7.</li>
<li>Use <code>times.seg_start(&quot;msg&quot;)</code> and <code>times.seg_stop(&quot;msg&quot;)</code> enclose a code block and print the time of start and stop. <code>msg</code> can be used to identify the code block in the output. </li>
<li>You can also add single checkpoint <code>times.last_seg</code> anywhere, it will print the time elapsed since last checkpoint which could be of any type.</li>
</ul>
<p>Here is an example of using timing script in <strong><em>Wordcount</em></strong>. You can search and highlight <code>times</code> to see all the edits needed in script.</p>
<pre><code><span class="comment">#!/usr/bin/python -tt</span>
<span class="comment"># Copyright 2010 Google Inc.</span>
<span class="comment"># Licensed under the Apache License, Version 2.0</span>
<span class="comment"># http://www.apache.org/licenses/LICENSE-2.0</span>

<span class="comment"># Google's Python Class</span>
<span class="comment"># http://code.google.com/edu/languages/google-python-class/</span>

<span class="string">"""Wordcount exercise
Google's Python class
"""</span>

<span class="keyword">import</span> sys
<span class="keyword">from</span> basic.util <span class="keyword">import</span> times

<span class="comment">###</span>
<span class="comment"># This basic command line argument parsing code is provided and</span>
<span class="comment"># calls the print_words() and print_top() functions which you must define.</span>

<span class="function"><span class="keyword">def</span> <span class="title">count_words</span><span class="params">(filename)</span>:</span>
    <span class="string">"""helper method for the other 2, return dict"""</span>
    <span class="comment"># read file into words</span>
    times.seg_start(<span class="string">'count words start'</span>)
    f = open(filename, <span class="string">'rU'</span>)
    word_count = {}
    <span class="keyword">for</span> line <span class="keyword">in</span> f:
        words = line.split()
        <span class="keyword">for</span> word <span class="keyword">in</span> words:
            word = word.lower()
            <span class="keyword">if</span> word <span class="keyword">in</span> word_count:      <span class="comment"># 0.069 for 640k</span>
            <span class="comment">#if word_count.get(word):     # 0.03s for 250k text, 0.084 for 640k</span>
                word_count[word] += <span class="number">1</span>
            <span class="keyword">else</span>:
                word_count[word] = <span class="number">1</span>
    times.seg_stop(<span class="string">'count words stop'</span>)
    <span class="keyword">return</span> word_count

<span class="function"><span class="keyword">def</span> <span class="title">print_words</span><span class="params">(filename)</span>:</span>
    <span class="string">"count words"</span>
    <span class="comment">#sort dict and print</span>
    word_count = count_words(filename)
    <span class="keyword">for</span> word <span class="keyword">in</span> sorted(word_count.keys()):
        <span class="keyword">print</span> word, word_count[word]

<span class="function"><span class="keyword">def</span> <span class="title">print_top</span><span class="params">(filename)</span>:</span>
    word_count = count_words(filename)
    word_count_pairs = word_count.items()
    times.seg_start(<span class="string">'sorting start'</span>)
    word_count_pairs = sorted(word_count_pairs, key = <span class="keyword">lambda</span> pair: pair[-<span class="number">1</span>], reverse=<span class="keyword">True</span>)
    times.seg_stop(<span class="string">'sorting stop'</span>)
    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>):
        <span class="keyword">print</span> word_count_pairs[i][<span class="number">0</span>], word_count_pairs[i][<span class="number">1</span>]
    times.last_seg()

<span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span>
  <span class="keyword">if</span> len(sys.argv) != <span class="number">3</span>:
    <span class="keyword">print</span> <span class="string">'usage: ./wordcount.py {--count | --topcount} file'</span>
    sys.exit(<span class="number">1</span>)
  times.start(<span class="number">5</span>)
  option = sys.argv[<span class="number">1</span>]
  filename = sys.argv[<span class="number">2</span>]
  <span class="keyword">if</span> option == <span class="string">'--count'</span>:
    print_words(filename)
  <span class="keyword">elif</span> option == <span class="string">'--topcount'</span>:
    print_top(filename)
  <span class="keyword">else</span>:
    <span class="keyword">print</span> <span class="string">'unknown option: '</span> + option
    sys.exit(<span class="number">1</span>)
  times.end()
<span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:
  main() 
</code></pre><p>I put some efforts in the print indenting to make the output aligned:</p>
<pre><code>=<span class="ruby"><span class="status">=&gt;</span>| <span class="constant">Timer</span> start | set to <span class="number">5</span> digits after decimal point
</span>=<span class="ruby">&gt; &lt;&lt; | <span class="number">0</span>          count words start
</span>      | 0.06900 s  count words stop  &gt;&gt;
=<span class="ruby">&gt; &lt;&lt; | <span class="number">0</span>          sorting start
</span>      | 0.00800 s  sorting stop  &gt;&gt;
the 5027
to 3353
and 2831
=<span class="ruby">&gt; | <span class="number">0</span>.<span class="number">00100</span> s since last point
</span>=<span class="ruby">&gt; | <span class="number">0</span>.<span class="number">00300</span> s since last point. <span class="constant">Timer</span> <span class="keyword">end</span>.
</span>=<span class="ruby"><span class="status">=&gt;</span>| <span class="number">0</span>.0860<span class="number">0</span> s <span class="constant">Total</span> time elapsed</span>
</code></pre><p>Here is the script. You can also download it from <a href="https://github.com/dracodoc/misc_utils/blob/master/times.py" target="_blank" rel="external">here</a>.</p>
<p><em><strong>times.py</strong></em></p>
<pre><code><span class="keyword">import</span> time

__author__ = <span class="string">'dracodoc'</span>
<span class="comment"># measure script time duration in segments. http://dracodoc.github.io/</span>
<span class="comment"># the clock value list: start, segments, end</span>
<span class="comment"># usage: import times, put times.start, seg_start, end etc in line.</span>
T = []
Digit = [<span class="number">7</span>]


<span class="function"><span class="keyword">def</span> <span class="title">start</span><span class="params">(digit=<span class="number">7</span>)</span>:</span>
    <span class="string">"""Timer start. digit control the number width to align"""</span>
    <span class="keyword">del</span> T[:]  <span class="comment"># clean up first</span>
    Digit[<span class="number">0</span>] = digit
    T.append(time.time())
    <span class="keyword">print</span> <span class="string">'==&gt;| Timer start | set to'</span>, Digit[<span class="number">0</span>], <span class="string">'digits after decimal point'</span>


<span class="function"><span class="keyword">def</span> <span class="title">last_seg</span><span class="params">(s=<span class="string">'since last point'</span>)</span>:</span>
    <span class="string">"""calculate the duration between last point till this one"""</span>
    T.append(time.time())
    duration = T[-<span class="number">1</span>] - T[-<span class="number">2</span>]
    <span class="keyword">print</span> <span class="string">"=&gt; | %.*f s"</span> % (Digit[<span class="number">0</span>], duration), s


<span class="function"><span class="keyword">def</span> <span class="title">seg_start</span><span class="params">(s=<span class="string">'start...'</span>)</span>:</span>
    <span class="string">"""set a segment start, always used with seg_stop in pairs"""</span>
    T.append(time.time())
    <span class="keyword">print</span> <span class="string">"=&gt; &lt;&lt; | 0"</span>, <span class="string">' '</span> * (Digit[<span class="number">0</span>] + <span class="number">3</span>), s


<span class="function"><span class="keyword">def</span> <span class="title">seg_stop</span><span class="params">(s=<span class="string">'...stop'</span>)</span>:</span>
    <span class="string">"""set a segment end, always used with seg_start in pairs"""</span>
    T.append(time.time())
    duration = T[-<span class="number">1</span>] - T[-<span class="number">2</span>]
    <span class="keyword">print</span> <span class="string">"      | %.*f s "</span> % (Digit[<span class="number">0</span>], duration), s, <span class="string">' &gt;&gt;'</span>

<span class="function"><span class="keyword">def</span> <span class="title">end</span><span class="params">(s=<span class="string">'since last point. Timer end.'</span>)</span>:</span>
    T.append(time.time())
    duration = T[-<span class="number">1</span>] - T[-<span class="number">2</span>]
    total = T[-<span class="number">1</span>] - T[<span class="number">0</span>]
    <span class="keyword">print</span> <span class="string">"=&gt; | %.*f s"</span> % (Digit[<span class="number">0</span>], duration), s
    <span class="keyword">print</span> <span class="string">"==&gt;| %.*f s"</span> % (Digit[<span class="number">0</span>], total), <span class="string">'Total time elapsed'</span>
</code></pre><p>Of course sometimes you want more features like execution frequency and memory analysis, then you can always use more powerful profiler like <a href="https://github.com/rkern/line_profiler" target="_blank" rel="external">line_profiler</a> and <a href="https://github.com/fabianp/memory_profiler" target="_blank" rel="external">memory profiler</a>. The profiler guide I mentioned earlier have detailed introductions on them. </p>
<p>That being said, I still found my simple timing script is often useful enough and easy to use with minimal overhead.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://dracodoc.github.io/2015/10/20/simple-python-performance-timing-by-checkpoints/" data-id="cig05wmyh00000kmtn1hfzxi8" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/python/">python</a></li></ul>

    </footer>
  </div>
  
    
  
</article>

</section>
        
          <aside id="sidebar">
  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/">python</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/python/" style="font-size: 10px;">python</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">October 2015</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2015/10/20/simple-python-performance-timing-by-checkpoints/">Simple Python performance timing by checkpoints</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2015 dracodoc<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


<script src="/js/script.js" type="text/javascript"></script>

  </div>
</body>
</html>