<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>A Python script inline timer | Artificial learning and Evolution inspired by nature</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="A Python script inline timerJanuary 15, 2015
I’ve been revisiting Python recently and found Google’s tutorial is easy to pick up. My first solution to one of the exercise “word count” took a lot of ti">
<meta property="og:type" content="article">
<meta property="og:title" content="A Python script inline timer">
<meta property="og:url" content="http://dracodoc.github.io/2015/10/20/pyTimer/index.html">
<meta property="og:site_name" content="Artificial learning and Evolution inspired by nature">
<meta property="og:description" content="A Python script inline timerJanuary 15, 2015
I’ve been revisiting Python recently and found Google’s tutorial is easy to pick up. My first solution to one of the exercise “word count” took a lot of ti">
<meta property="og:updated_time" content="2015-10-20T17:17:14.847Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="A Python script inline timer">
<meta name="twitter:description" content="A Python script inline timerJanuary 15, 2015
I’ve been revisiting Python recently and found Google’s tutorial is easy to pick up. My first solution to one of the exercise “word count” took a lot of ti">
  
    <link rel="alternative" href="/atom.xml" title="Artificial learning and Evolution inspired by nature" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  

</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Artificial learning and Evolution inspired by nature</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://dracodoc.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-pyTimer" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/10/20/pyTimer/" class="article-date">
  <time datetime="2015-10-20T17:17:14.847Z" itemprop="datePublished">2015-10-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      A Python script inline timer
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="A_Python_script_inline_timer">A Python script inline timer</h2><p>January 15, 2015</p>
<p>I’ve been revisiting Python recently and found Google’s tutorial is easy to pick up. My first solution to one of the exercise “word count” took a lot of time to analysis a 600K text, which is not right.</p>
<p>I want some profile tool to locate the bottle neck, and found this article pretty good. After using the simple timing context manager, I found the problem was that I used<br>if key in dict.keys() because I saw this usage before:<br>for key in sorted(dict.keys()):</p>
<p>However, this is a linear look up in a list which didn’t use the constant access performance of HashMap. The correct way is to use if key in dict .</p>
<p>The problem has been solved, but I’m not totally satisfied with the timing context manager tool. To use it means to indent code blocks, and moving timer position in script means lots of indent operations.</p>
<p>After some time I produced this script inline timer tool. To use it, just import the module, place times.start and times.end in the position you want in your script. It will print the total time elapsed between these two points in seconds. The precision is set by the digit parameter of times.start.</p>
<p>If you want more fine grained time measurement, one way is put any number of<br>times.last_seg in script between start and end. Each point will print the time elapsed since last segment point.</p>
<p>Another way is put time segment start and stops in pair to enclose any code block. You don’t need to indent existing code, just put times.seg_start and times.seg_stop before and after the code block.</p>
<p>All the methods except the times.start accept string parameters to mark the meaning of time point.</p>
<p><strong>times.py</strong></p>
<pre><code><span class="keyword">import</span> time

__author__ = <span class="string">'draco'</span>
<span class="comment"># measure script time duration in segments</span>
<span class="comment"># the clock value list: start, segments, end</span>
<span class="comment"># usage: import times, put times.start, seg_start, end etc in line.</span>
T = []
Digit = [<span class="number">7</span>]


<span class="function"><span class="keyword">def</span> <span class="title">start</span><span class="params">(digit=<span class="number">7</span>)</span>:</span>
    <span class="string">"""Timer start. digit control the number width to align"""</span>
    <span class="keyword">del</span> T[:]  <span class="comment"># clean up first</span>
    Digit[<span class="number">0</span>] = digit
    T.append(time.time())
    <span class="keyword">print</span> <span class="string">'==&gt;| Timer start | set to'</span>, Digit[<span class="number">0</span>], <span class="string">'digits after decimal point'</span>


<span class="function"><span class="keyword">def</span> <span class="title">last_seg</span><span class="params">(s=<span class="string">'since last point'</span>)</span>:</span>
    <span class="string">"""calculate the duration between last point till this one"""</span>
    T.append(time.time())
    duration = T[-<span class="number">1</span>] - T[-<span class="number">2</span>]
    <span class="keyword">print</span> <span class="string">"=&gt; | %.*f s"</span> % (Digit[<span class="number">0</span>], duration), s


<span class="function"><span class="keyword">def</span> <span class="title">seg_start</span><span class="params">(s=<span class="string">'start...'</span>)</span>:</span>
    <span class="string">"""set a segment start, always used with seg_stop in pairs"""</span>
    T.append(time.time())
    <span class="keyword">print</span> <span class="string">"=&gt; &lt;&lt; | 0"</span>, <span class="string">' '</span> * (Digit[<span class="number">0</span>] + <span class="number">3</span>), s


<span class="function"><span class="keyword">def</span> <span class="title">seg_stop</span><span class="params">(s=<span class="string">'...stop'</span>)</span>:</span>
    <span class="string">"""set a segment end, always used with seg_start in pairs"""</span>
    T.append(time.time())
    duration = T[-<span class="number">1</span>] - T[-<span class="number">2</span>]
    <span class="keyword">print</span> <span class="string">"      | %.*f s "</span> % (Digit[<span class="number">0</span>], duration), s, <span class="string">' &gt;&gt;'</span>

<span class="function"><span class="keyword">def</span> <span class="title">end</span><span class="params">(s=<span class="string">'since last point. Timer end.'</span>)</span>:</span>
    T.append(time.time())
    duration = T[-<span class="number">1</span>] - T[-<span class="number">2</span>]
    total = T[-<span class="number">1</span>] - T[<span class="number">0</span>]
    <span class="keyword">print</span> <span class="string">"=&gt; | %.*f s"</span> % (Digit[<span class="number">0</span>], duration), s
    <span class="keyword">print</span> <span class="string">"==&gt;| %.*f s"</span> % (Digit[<span class="number">0</span>], total), <span class="string">'Total time elapsed'</span>
</code></pre><p>Using timer in script:</p>
<pre><code><span class="comment">#!/usr/bin/python -tt</span>
<span class="comment"># Copyright 2010 Google Inc.</span>
<span class="comment"># Licensed under the Apache License, Version 2.0</span>
<span class="comment"># http://www.apache.org/licenses/LICENSE-2.0</span>

<span class="comment"># Google's Python Class</span>
<span class="comment"># http://code.google.com/edu/languages/google-python-class/</span>

<span class="string">"""Wordcount exercise
Google's Python class
"""</span>

<span class="keyword">import</span> sys

<span class="keyword">from</span> basic.util <span class="keyword">import</span> times


<span class="comment">###</span>

<span class="comment"># This basic command line argument parsing code is provided and</span>
<span class="comment"># calls the print_words() and print_top() functions which you must define.</span>

<span class="function"><span class="keyword">def</span> <span class="title">count_words</span><span class="params">(filename)</span>:</span>
    <span class="string">"""helper method for the other 2, return dict"""</span>
    <span class="comment"># read file into words</span>
    times.seg_start(<span class="string">'count words start'</span>)
    f = open(filename, <span class="string">'rU'</span>)
    word_count = {}
    <span class="keyword">for</span> line <span class="keyword">in</span> f:
        words = line.split()
        <span class="keyword">for</span> word <span class="keyword">in</span> words:
            word = word.lower()
            <span class="keyword">if</span> word <span class="keyword">in</span> word_count:      <span class="comment"># in dict.keys() could be slow, didn't use hash. 0.069 for 640k</span>
            <span class="comment">#if word_count.get(word): # 0.03s for 250k text, 0.084 for 640k</span>
                word_count[word] += <span class="number">1</span>
            <span class="keyword">else</span>:
                word_count[word] = <span class="number">1</span>
    times.seg_stop(<span class="string">'count words stop'</span>)
    <span class="keyword">return</span> word_count

<span class="function"><span class="keyword">def</span> <span class="title">print_words</span><span class="params">(filename)</span>:</span>
    <span class="string">"count words"</span>
    <span class="comment">#sort dict and print</span>
    word_count = count_words(filename)
    <span class="keyword">for</span> word <span class="keyword">in</span> sorted(word_count.keys()):
        <span class="keyword">print</span> word, word_count[word]


<span class="function"><span class="keyword">def</span> <span class="title">print_top</span><span class="params">(filename)</span>:</span>
    word_count = count_words(filename)
    word_count_pairs = word_count.items()
    times.seg_start(<span class="string">'sorting start'</span>)
    word_count_pairs = sorted(word_count_pairs, key = <span class="keyword">lambda</span> pair: pair[-<span class="number">1</span>], reverse=<span class="keyword">True</span>)
    times.seg_stop(<span class="string">'sorting stop'</span>)
    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>):
        <span class="keyword">print</span> word_count_pairs[i][<span class="number">0</span>], word_count_pairs[i][<span class="number">1</span>]
    times.last_seg()

<span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span>
  <span class="keyword">if</span> len(sys.argv) != <span class="number">3</span>:
    <span class="keyword">print</span> <span class="string">'usage: ./wordcount.py {--count | --topcount} file'</span>
    sys.exit(<span class="number">1</span>)
  times.start(<span class="number">5</span>)
  option = sys.argv[<span class="number">1</span>]
  filename = sys.argv[<span class="number">2</span>]
  <span class="keyword">if</span> option == <span class="string">'--count'</span>:
    print_words(filename)
  <span class="keyword">elif</span> option == <span class="string">'--topcount'</span>:
    print_top(filename)
  <span class="keyword">else</span>:
    <span class="keyword">print</span> <span class="string">'unknown option: '</span> + option
    sys.exit(<span class="number">1</span>)
  times.end()
<span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:
  main() 
</code></pre><p>The output:</p>
<pre><code>=<span class="ruby"><span class="status">=&gt;</span>| <span class="constant">Timer</span> start | set to <span class="number">5</span> digits after decimal point
</span>=<span class="ruby">&gt; &lt;&lt; | <span class="number">0</span>          count words start
</span>      | 0.06900 s  count words stop  &gt;&gt;
=<span class="ruby">&gt; &lt;&lt; | <span class="number">0</span>          sorting start
</span>      | 0.00800 s  sorting stop  &gt;&gt;
the 5027
to 3353
and 2831
=<span class="ruby">&gt; | <span class="number">0</span>.<span class="number">00100</span> s since last point
</span>=<span class="ruby">&gt; | <span class="number">0</span>.<span class="number">00300</span> s since last point. <span class="constant">Timer</span> <span class="keyword">end</span>.
</span>=<span class="ruby"><span class="status">=&gt;</span>| <span class="number">0</span>.0860<span class="number">0</span> s <span class="constant">Total</span> time elapsed</span>
</code></pre>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://dracodoc.github.io/2015/10/20/pyTimer/" data-id="cifzmw0pw0001rcmt00rssusg" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2015/10/20/hello-world/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">entry page</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  
    
  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">October 2015</a><span class="archive-list-count">2</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2015/10/20/pyTimer/">A Python script inline timer</a>
          </li>
        
          <li>
            <a href="/2015/10/20/hello-world/">entry page</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2015 dracodoc<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


<script src="/js/script.js" type="text/javascript"></script>

  </div>
</body>
</html>